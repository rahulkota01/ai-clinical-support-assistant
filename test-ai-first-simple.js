// Simple AI-First Test for Clinical Analysis System
// Tests AI-first behavior and fallback logic

// Mock the generateSafetyReport function based on the actual implementation
async function mockGenerateSafetyReport(patient, shouldFail = false) {
  console.log(`ğŸ¤– AI-FIRST: Attempting AI clinical analysis for ${patient.fullName}...`);
  
  if (shouldFail) {
    console.log('âŒ AI FAILURE: Simulating service unavailable error');
    console.log('ğŸ”„ TEMPORARY FALLBACK: Using logic-based clinical analysis for this request only');
    console.log('ğŸ”„ AUTOMATIC RECOVERY: Next request will attempt AI first again');
    
    // Return fallback logic result
    return generateFallbackClinicalAnalysis(patient);
  }
  
  // Simulate AI success
  console.log('âœ… AI SUCCESS: Clinical analysis generated with AI model');
  return generateAIClinicalAnalysis(patient);
}

// Mock AI clinical analysis
function generateAIClinicalAnalysis(patient) {
  return `AI-Generated Clinical Analysis for ${patient.fullName}

Patient Overview
${patient.fullName} is a ${patient.age}-year-old ${patient.sex} presenting with ${patient.complaints}.

Chief Complaints
${patient.complaints}

Vital Signs Analysis
- Blood Pressure: ${patient.baselineVitals.bp}
- Heart Rate: ${patient.baselineVitals.hr}
- Temperature: ${patient.baselineVitals.temp}
- SpO2: ${patient.baselineVitals.spo2}

Laboratory Findings
- WBC: ${patient.baselineLabs?.wbc || 'N/A'}
- Platelets: ${patient.baselineLabs?.platelets || 'N/A'}
- RBC: ${patient.baselineLabs?.rbc || 'N/A'}
- Creatinine: ${patient.baselineLabs?.creatinine || 'N/A'}

Clinical Assessment
AI-powered analysis indicates ${patient.complaints.toLowerCase().includes('chest') ? 'cardiac evaluation' : 'general medical evaluation'} recommended.

Treatment Recommendations
Based on AI analysis: Standard treatment protocols apply.

Follow-up Plan
AI recommends follow-up based on clinical findings.

Disclaimer: This analysis was generated by AI and should be reviewed by healthcare professionals.`;
}

// Mock fallback clinical analysis
function generateFallbackClinicalAnalysis(patient) {
  return `Logic-Based Clinical Analysis for ${patient.fullName}

Patient Overview
${patient.fullName} is a ${patient.age}-year-old ${patient.sex} presenting with ${patient.complaints}.

Chief Complaints
${patient.complaints}

Vital Signs Analysis
- Blood Pressure: ${patient.baselineVitals.bp}
- Heart Rate: ${patient.baselineVitals.hr}
- Temperature: ${patient.baselineVitals.temp}
- SpO2: ${patient.baselineVitals.spo2}

Laboratory Findings
- WBC: ${patient.baselineLabs?.wbc || 'N/A'}
- Platelets: ${patient.baselineLabs?.platelets || 'N/A'}
- RBC: ${patient.baselineLabs?.rbc || 'N/A'}
- Creatinine: ${patient.baselineLabs?.creatinine || 'N/A'}

Clinical Assessment
Logic-based analysis indicates ${patient.complaints.toLowerCase().includes('chest') ? 'cardiac evaluation' : 'general medical evaluation'} recommended.

Treatment Recommendations
Based on clinical guidelines: Standard treatment protocols apply.

Follow-up Plan
Standard follow-up recommended based on clinical findings.

Disclaimer: This analysis was generated using logic-based algorithms and should be reviewed by healthcare professionals.`;
}

// Test data
const testPatients = [
  {
    id: 'TEST-001',
    fullName: 'John Doe',
    age: 45,
    sex: 'Male',
    complaints: 'Chest pain for 2 hours',
    baselineVitals: { bp: '140/90', hr: '88', temp: '98.6', spo2: '98%' },
    baselineLabs: { wbc: '7.5', platelets: '250', rbc: '4.5', creatinine: '1.2' }
  },
  {
    id: 'TEST-002',
    fullName: 'Jane Smith',
    age: 32,
    sex: 'Female',
    complaints: 'Headache and dizziness',
    baselineVitals: { bp: '120/80', hr: '72', temp: '98.4', spo2: '99%' },
    baselineLabs: { wbc: '6.8', platelets: '280', rbc: '4.2', creatinine: '0.9' }
  },
  {
    id: 'TEST-003',
    fullName: 'Robert Johnson',
    age: 67,
    sex: 'Male',
    complaints: 'Shortness of breath',
    baselineVitals: { bp: '160/100', hr: '95', temp: '99.0', spo2: '94%' },
    baselineLabs: { wbc: '8.2', platelets: '220', rbc: '4.8', creatinine: '1.8' }
  }
];

// Test results tracking
const testResults = {
  totalTests: 0,
  aiAttempts: 0,
  aiSuccesses: 0,
  fallbackUsed: 0,
  responseTimes: [],
  accuracy: 0,
  aiFirstBehavior: true,
  automaticRecovery: true
};

// Validation function
function validateClinicalAnalysis(result, patient) {
  const validation = {
    hasPatientOverview: result.includes('Patient Overview'),
    hasChiefComplaints: result.includes('Chief Complaints'),
    hasVitalSigns: result.includes('Vital Signs Analysis'),
    hasLabFindings: result.includes('Laboratory Findings'),
    hasClinicalAssessment: result.includes('Clinical Assessment'),
    hasTreatmentRecommendations: result.includes('Treatment Recommendations'),
    hasFollowUpPlan: result.includes('Follow-up Plan'),
    hasDisclaimer: result.includes('Disclaimer'),
    isAIGenerated: result.includes('AI-Generated'),
    isLogicBased: result.includes('Logic-Based'),
    score: 0
  };
  
  // Calculate score
  const requiredSections = [
    'hasPatientOverview',
    'hasChiefComplaints', 
    'hasVitalSigns',
    'hasLabFindings',
    'hasClinicalAssessment',
    'hasTreatmentRecommendations',
    'hasFollowUpPlan',
    'hasDisclaimer'
  ];
  
  validation.score = (requiredSections.filter(section => validation[section]).length / requiredSections.length) * 100;
  
  return validation;
}

// Main test function
async function runAIFirstTest() {
  console.log('ğŸ§ª Starting AI-First Clinical Analysis Test');
  console.log('==================================================');
  
  // Test 1: AI Success (normal operation)
  console.log('\nğŸ“‹ Test 1: AI Success (Normal Operation)');
  console.log('-------------------------------------------');
  
  for (let i = 0; i < testPatients.length; i++) {
    const patient = testPatients[i];
    const startTime = Date.now();
    
    testResults.totalTests++;
    testResults.aiAttempts++;
    
    try {
      const result = await mockGenerateSafetyReport(patient, false);
      const responseTime = Date.now() - startTime;
      const validation = validateClinicalAnalysis(result, patient);
      
      testResults.responseTimes.push(responseTime);
      
      if (validation.isAIGenerated) {
        testResults.aiSuccesses++;
        console.log(`âœ… Patient ${patient.id}: AI Success (${responseTime}ms, Score: ${validation.score.toFixed(1)}%)`);
      } else {
        console.log(`âŒ Patient ${patient.id}: Expected AI but got logic-based result`);
        testResults.aiFirstBehavior = false;
      }
      
    } catch (error) {
      console.log(`âŒ Patient ${patient.id}: Error - ${error.message}`);
    }
  }
  
  // Test 2: AI Failure with Fallback
  console.log('\nğŸ“‹ Test 2: AI Failure with Fallback');
  console.log('--------------------------------------');
  
  for (let i = 0; i < testPatients.length; i++) {
    const patient = testPatients[i];
    const startTime = Date.now();
    
    testResults.totalTests++;
    testResults.aiAttempts++;
    
    try {
      const result = await mockGenerateSafetyReport(patient, true);
      const responseTime = Date.now() - startTime;
      const validation = validateClinicalAnalysis(result, patient);
      
      testResults.responseTimes.push(responseTime);
      
      if (validation.isLogicBased) {
        testResults.fallbackUsed++;
        console.log(`âœ… Patient ${patient.id}: Fallback Success (${responseTime}ms, Score: ${validation.score.toFixed(1)}%)`);
      } else {
        console.log(`âŒ Patient ${patient.id}: Expected fallback but got AI result`);
      }
      
    } catch (error) {
      console.log(`âŒ Patient ${patient.id}: Error - ${error.message}`);
    }
  }
  
  // Test 3: Automatic Recovery (AI should be attempted again after failure)
  console.log('\nğŸ“‹ Test 3: Automatic Recovery');
  console.log('------------------------------');
  
  const patient = testPatients[0];
  const startTime = Date.now();
  
  testResults.totalTests++;
  testResults.aiAttempts++;
  
  try {
    // First call fails
    await mockGenerateSafetyReport(patient, true);
    
    // Second call should attempt AI again
    const result = await mockGenerateSafetyReport(patient, false);
    const responseTime = Date.now() - startTime;
    const validation = validateClinicalAnalysis(result, patient);
    
    testResults.responseTimes.push(responseTime);
    
    if (validation.isAIGenerated) {
      console.log(`âœ… Automatic Recovery: AI attempted again and succeeded (${responseTime}ms, Score: ${validation.score.toFixed(1)}%)`);
    } else {
      console.log(`âŒ Automatic Recovery failed: AI not attempted again`);
      testResults.automaticRecovery = false;
    }
    
  } catch (error) {
    console.log(`âŒ Automatic Recovery: Error - ${error.message}`);
    testResults.automaticRecovery = false;
  }
  
  // Calculate final results
  testResults.accuracy = (testResults.aiSuccesses / testResults.aiAttempts) * 100;
  
  // Display results
  console.log('\nğŸ“Š TEST RESULTS');
  console.log('================');
  console.log(`Total Tests: ${testResults.totalTests}`);
  console.log(`AI Attempts: ${testResults.aiAttempts}`);
  console.log(`AI Successes: ${testResults.aiSuccesses}`);
  console.log(`Fallback Used: ${testResults.fallbackUsed}`);
  console.log(`AI Accuracy: ${testResults.accuracy.toFixed(1)}%`);
  console.log(`AI-First Behavior: ${testResults.aiFirstBehavior ? 'âœ… PASS' : 'âŒ FAIL'}`);
  console.log(`Automatic Recovery: ${testResults.automaticRecovery ? 'âœ… PASS' : 'âŒ FAIL'}`);
  
  if (testResults.responseTimes.length > 0) {
    const avgResponseTime = testResults.responseTimes.reduce((a, b) => a + b, 0) / testResults.responseTimes.length;
    console.log(`Average Response Time: ${avgResponseTime.toFixed(0)}ms`);
  }
  
  // Final assessment
  console.log('\nğŸ¯ FINAL ASSESSMENT');
  console.log('===================');
  
  const allTestsPassed = testResults.aiFirstBehavior && testResults.automaticRecovery && testResults.accuracy >= 85;
  
  if (allTestsPassed) {
    console.log('ğŸ‰ ALL TESTS PASSED!');
    console.log('âœ… AI-First behavior working correctly');
    console.log('âœ… Automatic recovery working correctly');
    console.log('âœ… Accuracy meets 85%+ requirement');
    console.log('âœ… System ready for production');
  } else {
    console.log('âŒ SOME TESTS FAILED!');
    if (!testResults.aiFirstBehavior) {
      console.log('âŒ AI-First behavior not working');
    }
    if (!testResults.automaticRecovery) {
      console.log('âŒ Automatic recovery not working');
    }
    if (testResults.accuracy < 85) {
      console.log(`âŒ Accuracy below 85%: ${testResults.accuracy.toFixed(1)}%`);
    }
    console.log('ğŸ”„ System needs improvement before production');
  }
  
  return testResults;
}

// Run the test
runAIFirstTest().then(results => {
  console.log('\nâœ… Test completed successfully');
}).catch(error => {
  console.error('\nâŒ Test failed:', error);
});
